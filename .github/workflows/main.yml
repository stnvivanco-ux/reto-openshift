name: Publish-Helm-Chart

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  publish-chart:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Show chart structure (debug opcional)
        run: |
          ls -R

      - name: Package Helm chart
        run: |
          cd charts
          helm lint .
          helm package .
          ls -l

      - name: Login to Docker Hub (OCI Registry)
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | helm registry login registry-1.docker.io \
            --username "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password-stdin

      - name: Push chart to Docker Hub
        run: |
          cd charts
          # Ajusta la versi√≥n si cambias 'version' en Chart.yaml
          helm push mi-chart-0.1.0.tgz oci://registry-1.docker.io/savivancofi